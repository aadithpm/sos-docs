<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-107286198-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-107286198-1');
</script>

<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<title>SoS_Docker_Guide</title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>








<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Loading mathjax macro -->
<!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>

<meta name="viewport" content="width=device-width, initial-scale=1">
 <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet">
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>

<style>  /* defined here in case the main.css below cannot be loaded */
.lev1 {margin-left: 80px}
.lev2 {margin-left: 100px}
.lev3 {margin-left: 120px}
.lev4 {margin-left: 140px}
.lev5 {margin-left: 160px}
.lev6 {margin-left: 180px}
</style>

<link rel="stylesheet" type="text/css" href="../../css/jt.css">
<link rel="stylesheet" type="text/css" href="../../css/toc2.css">

<script src="../../js/doc_toc.js"></script>

 <script src="../../js/docs.js"></script>

<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["STIX","TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>

<script>

function filterDataFrame(id) {
    var input = document.getElementById("search_" + id);
    var filter = input.value.toUpperCase();
    var table = document.getElementById("dataframe_" + id);
    var tr = table.getElementsByTagName("tr");

    // Loop through all table rows, and hide those who don't match the search query
    for (var i = 1; i < tr.length; i++) {
        for (var j = 0; j < tr[i].cells.length; ++j) {
            var matched = false;
            if (tr[i].cells[j].innerHTML.toUpperCase().indexOf(filter) != -1) {
                tr[i].style.display = "";
                matched = true
                break;
            }
            if (!matched)
                tr[i].style.display = "none";
        } 
    }
}

function sortDataFrame(id, n, dtype) {
    var table = document.getElementById("dataframe_" + id);

    var tb = table.tBodies[0]; // use `<tbody>` to ignore `<thead>` and `<tfoot>` rows
    var tr = Array.prototype.slice.call(tb.rows, 0); // put rows into array

    if (dtype === 'numeric') {
        var fn = function(a, b) { 
            return parseFloat(a.cells[n].textContent) <= parseFloat(b.cells[n].textContent) ? -1 : 1;
        }
    } else {
        var fn = function(a, b) {
            var c = a.cells[n].textContent.trim().localeCompare(b.cells[n].textContent.trim()); 
            return c > 0 ? 1 : (c < 0 ? -1 : 0) }
    }
    var isSorted = function(array, fn) {
        if (array.length < 2)
            return 1;
        var direction = fn(array[0], array[1]); 
        for (var i = 1; i < array.length - 1; ++i) {
            var d = fn(array[i], array[i+1]);
            if (d == 0)
                continue;
            else if (direction == 0)
                direction = d;
            else if (direction != d)
                return 0;
            }
        return direction;
    }

    var sorted = isSorted(tr, fn);

    if (sorted == 1 || sorted == -1) {
        // if sorted already, reverse it
        for(var i = tr.length - 1; i >= 0; --i)
            tb.appendChild(tr[i]); // append each row in order
    } else {
        tr = tr.sort(fn);
        for(var i = 0; i < tr.length; ++i)
            tb.appendChild(tr[i]); // append each row in order
    }
}


$( document ).ready(function(){

            var cfg={'threshold':3,     // depth of toc (number of levels)
             // 'number_sections': false,  
             'number_sections': false,  // sections numbering
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             // 'sideBar':false,      
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }

            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;

            // fire the main function with these parameters


            table_of_contents(cfg,st);


            var file=tutorialsDict[$("h1:first").attr("id")];
            var path="http://vatlab.github.io/sos-docs"
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            
            var tuts=tutorials;
            var pos=tutorials.indexOf(file);
        
            for (var a=pos;a>=0;a--){
                  var name=tuts[a]
                  $('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace(/_/g," ")
                        + '&nbsp ' + '<i class="fa ' +
                      (a === pos ? 'fa-caret-down' : 'fa-caret-right') + '"></i>' + '</a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+path+'/doc/tutorials/'+file+'.html'+'"]').css("color","#126dce");

            for (var a=pos+1;a<tuts.length;a++){
                  var name=tuts[a]
                  $(".toc #toc-level0").append('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace(/_/g," ")
                    + '&nbsp' + '<i class="fa fa-caret-right"></i>' +'</a></li>');
            }

            // for (var a =0;a<tuts.length;a++){
            //       var name =tuts[a];
            //       if ()
            //       $(".toc #toc-level0").append('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace("_"," ")+'</a></li>');
            // }

            // $(".toc #toc-level0").append('<li id="indexHome"><a href="'+path+'/index.html"><b>Home<b></a></li>');
            // var home=$("#toc-level0 #indexHome");
          
            // home.insertBefore("#toc-level0 li:eq(0)");

            
            // $(".number_sections-btn").hide();
            // $(".toc_cell_sections-btn".hide();


    });
</script><style>  /* defined here in case the main.css below cannot be loaded */

 .lan_SoS {}

</style>
<body>
  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="SoS-Docker-Guide">SoS Docker Guide<a class="anchor-link" href="#SoS-Docker-Guide">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="General-introduction">General introduction<a class="anchor-link" href="#General-introduction">&#182;</a></h2><h3 id="What-is-docker-and-why-it-is-helpful">What is docker and why it is helpful<a class="anchor-link" href="#What-is-docker-and-why-it-is-helpful">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is a big question to answer but in essence you can think docker containers as virtual machines with applications but without the bulky OS part, or applications with stripped down OSes. Docker containers are much more lightweight than virtual machines because all docker containers share the same core OS and related containers (e.g. different applications derived from the same CentOS or Ubuntu OS) share the same base container. Please refer to the <a href="https://www.docker.com/">docker website</a> for details about docker. I have found it helpful to watch a few youtube videos on docker.</p>
<p>The reason why docker is very helpful in building (bioinformatics) workflows are that</p>
<ol>
<li><p>Applications are encapsulated in docker containers so that they do not interfere with the underlying OS, and with other applications. For example, we can run a workflow with applications that based on different versions of Python2 and Python 3 without having to install them locally and calling the correct version of Python, because all applications use the specific version of Python and required libraries and tools inside their own containers.</p>
</li>
<li><p>Workflows will be more stable and reproducible because unlike, for example, a local installation of Python that can be affected by other software and upgrades of python, Docker containers are stable and will not change.</p>
</li>
<li><p>The same docker containers can be executed on different OS (e.g. various version of Linux, MacOSX etc) so your workflow built on a Mac OS workstation can be executed on a cluster environment.</p>
</li>
</ol>
<p>There are of course some complexity in the use of docker but SoS has made it extremely easy to use docker in your workflows.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Installing-and-configuring-docker">Installing and configuring docker<a class="anchor-link" href="#Installing-and-configuring-docker">&#182;</a></h3><p>Docker is relatively new and is evolving very fast. It is crucial for you to install the latest version from <a href="https://www.docker.com/">docker website</a>. This website provides very detailed step by step instruction and you should have no problem installing docker on your machine.</p>
<p>After installation, you should be able to start a docker terminal and run command</p>
<div class="highlight"><pre><span></span>$ docker run hello-world
</pre></div>
<p>as suggested by the documentation. Depending on the different versions of docker (e.g. docker under windows), docker might be run under a virtual machine. It is very important to understand that <strong>the configuration (e.g. RAM, CPU) of docker machines are different from the host machines</strong> so your docker machine might be restricuted to, for example, 1 CPU, 1G of RAM, which is insufficient for any serious work. You will most likely need to re-configure your docker virtual machine (e.g. from VirtualBox app locate a machine named <code>default</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Running-a-script-inside-docker">Running a script inside docker<a class="anchor-link" href="#Running-a-script-inside-docker">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="How-SoS-works-with-docker">How SoS works with docker<a class="anchor-link" href="#How-SoS-works-with-docker">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>SoS executes scripts inside docker by calling command <code>docker run</code> with appropriate parameters. Suppose you do not have ruby installed locally and would like to run a ruby script, you can execute it inside a <code>ruby</code> container.</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">run</span>
<span class="kn">ruby:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;ruby&#39;</span>
    <span class="n">line1</span> <span class="o">=</span> <span class="s2">&quot;Cats are smarter than dogs&quot;</span><span class="p">;</span>
    <span class="n">line2</span> <span class="o">=</span> <span class="s2">&quot;Dogs also like meat&quot;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="n">line1</span> <span class="o">=~</span> <span class="o">/</span><span class="n">Cats</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span><span class="o">/</span> <span class="p">)</span>
      <span class="n">puts</span> <span class="s2">&quot;Line1 contains Cats&quot;</span>
    <span class="n">end</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">line2</span> <span class="o">=~</span> <span class="o">/</span><span class="n">Cats</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span><span class="o">/</span> <span class="p">)</span>
      <span class="n">puts</span> <span class="s2">&quot;Line2 contains  Dogs&quot;</span>
    <span class="n">end</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Line1 contains Cats
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The actual <code>docker run</code> command executed by SoS could be shown with option <code>-v3</code> to the <code>%run</code> command, and would look similar to</p>

<pre><code>docker run --rm  
    -v $(pwd):$(pwd)
    -v /tmp/path/to/docker_run_30258.rb:/var/lib/sos/docker_run_30258.rb
    -t -P 
    -w=/Users/bpeng1/sos/sos-docs/src/tutorials
    -u 12345:54321    ruby
    ruby /var/lib/sos/docker_run_30258.rb</code></pre>
<p>Basically, SoS downloads a docker image called <code>ruby</code> and runs command <code>docker run</code> to execte the specified script, with the following options</p>
<ul>
<li><code>--rm</code> Automatically remove the container when it exits</li>
<li><code>-v $(pwd):$(pwd)</code> maps current working directory to the docker image so that it can be accessed from within the docker image</li>
<li><code>-v /tmp/path/to/docker_run_30258.rb:/var/lib/sos/docker_run_30258.rb</code> maps a temporary script (<code>/Users/bpeng1/sos/sos-docs/src/tutorials/tmp2zviq3qh/docker_run_30258.rb</code> to the docker image.</li>
<li><code>-t</code> Allocate a pseudo-tty</li>
<li><code>-P</code> Publish all exposed ports to the host interfaces</li>
<li><code>-w=/Users/bpeng1/sos/sos-docs/src/tutorials</code> Set working directory to current working directory</li>
<li><code>-u 12345:54321</code> Use the host user-id and group-id inside docker so that files created by docker (on shared volumes) could be accessible from outside of docker.</li>
<li><code>ruby</code> name of the docker image</li>
<li><code>ruby /var/lib/sos/docker_run_30258.rb</code> command that execute the script.</li>
</ul>
<p>The details of these options could be found at the <a href="https://docs.docker.com/engine/reference/run/">docker run manual</a>. They are chosen by the default to work with a majority of the scenarios but can fail for some docker images, in which case you will need to use SoS action parameters to customized how the images are executed. These parameters include general <a href="https://vatlab.github.io/sos-docs/doc/documentation/Targets_and_Actions.html#Action-options-12">action parameters</a> and <a href="https://vatlab.github.io/sos-docs/doc/documentation/Targets_and_Actions.html#docker_image">parameters that are specific to <code>docker_image</code></a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Building-docker-image-on-the-fly">Building docker-image on-the-fly<a class="anchor-link" href="#Building-docker-image-on-the-fly">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Building a docker image is usually done outside of SoS if you are maintaining a collection of docker containers to be shared by your workflows, your groups, or everyone. However, if you need to create a docker image on-the-fly or would like to embed the Dockerfile inside a SoS script, you can use the <code>docker_build</code> action to build a docker container.</p>
<p>For example, you can build simple image</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">docker_build:</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;test_docker&#39;</span>
  <span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">14.04</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[2]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>0</pre>
</div>

</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>and use the image</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;test_docker&#39;</span>
  <span class="n">ls</span> <span class="o">/</span><span class="n">usr</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>bin  games  include  lib  local  sbin  share  src
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This tutorial will use the <code>docker_build</code> action to build a few simple docker images to demonstrate the use of various options.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Customized-or-image-default-working-directory-(workdir-and-docker_workdir)">Customized or image-default working directory (<code>workdir</code> and <code>docker_workdir</code>)<a class="anchor-link" href="#Customized-or-image-default-working-directory-(workdir-and-docker_workdir)">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>SoS by default sets the current working directory of the docker image to the working directory of the host system, essentially adding <code>-w $(pwd)</code> to the command line. For example, with the following docker image, the <code>pwd</code> of the script is the current working directory on the host machine.</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;ubuntu:14.04&#39;</span>
  <span class="n">echo</span> <span class="sb">`pwd`</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>/Users/bpeng1/sos/sos-docs/src/tutorials
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since the action option <code>workdir</code> can change the working directory of the script, you can use this option to change the script of the working directory of the docker image as well. For example, SoS in the following example will change the current working directory to the parent directory before executing <code>docker run</code> there.</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;ubuntu:14.04&#39;</span><span class="p">,</span> <span class="kp">workdir</span><span class="o">=</span><span class="s1">&#39;..&#39;</span>
  <span class="n">echo</span> <span class="sb">`pwd`</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>/Users/bpeng1/sos/sos-docs/src
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This default behavior is convenient when you use commands in docker images to process input files on your host machine but it has two caveats:</p>
<ol>
<li>The docker image might have its own <code>WORKDIR</code> for the command to work. For example, a docker image can provide an application that is not in standard <code>$PATH</code> so it can only be executed in a specified <code>WORKDIR</code>.</li>
<li>You might need to specify a working directory inside of docker that does not exist in the host machine.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Option <code>docker_workdir</code>, if specified, overrides <code>workdir</code> and allows the use of default or customized working directory inside of docker images. When <code>docker_workdir</code> is set to <code>None</code>, no <code>-w</code> option will be passed to the docker image and the default <code>WORKDIR</code> will be used. Otherwise an absolute path inside the docker image can be specified.</p>
<p>For example, the following customized docker image has a <code>WORKDIR</code> set to <code>/usr</code>. It is working directory is set to host working directory by default, to <code>/usr</code> with <code>docker_workdir=None</code>, and <code>/home/random_user</code> with <code>docker_workdir='/home/random_user'</code>.</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">docker_build:</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;test_docker_workdir&#39;</span>
  <span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">14.04</span>
  <span class="n">WORKDIR</span> <span class="o">/</span><span class="n">usr</span>

<span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;test_docker_workdir&#39;</span>
  <span class="n">echo</span> <span class="sb">`pwd`</span>
  
<span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;test_docker_workdir&#39;</span><span class="p">,</span> <span class="n">docker_workdir</span><span class="o">=</span><span class="bp">None</span>
  <span class="n">echo</span> <span class="sb">`pwd`</span>
  
<span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;test_docker_workdir&#39;</span><span class="p">,</span> <span class="n">docker_workdir</span><span class="o">=</span><span class="s1">&#39;/home/random_user&#39;</span>
  <span class="n">echo</span> <span class="sb">`pwd`</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>/Users/bpeng1/sos/sos-docs/src/tutorials
/usr
/home/random_user
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note the directory is relative to the docker file system so it does not have to exist on the host system. Docker also creates <code>docker_workdir</code> if it does not exist so you do not have to create the directory in advance.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Sharing-of-input-and-output-files-(volumes)">Sharing of input and output files (<code>volumes</code>)<a class="anchor-link" href="#Sharing-of-input-and-output-files-(volumes)">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Because the working directory of the docker image is set by default to the current working directory, you can apply a command inside a docker image to files in the current working directory, and create files in it as well.</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;ubuntu:14.04&#39;</span>
  <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="n">SoS_Docker_Guide</span><span class="o">.</span><span class="n">ipynb</span> <span class="o">&gt;</span> <span class="n">docker_wc</span><span class="o">.</span><span class="n">txt</span>
  
<span class="kn">sh:</span>
  <span class="n">cat</span> <span class="n">docker_wc</span><span class="o">.</span><span class="n">txt</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>731 SoS_Docker_Guide.ipynb
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This works because SoS automatically shares the home directory  (<code>/Users</code> for mac and <code>/home</code> for Linux) and current working directory (if not under <code>$HOME</code>) of the host system to the docker image. Because the docker image can only "see" file systems shared by command <code>docker run</code>, your script will fail if your input files or output files are not under current working directory.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For example, the following script write something to a mobile harddrive (<code>/Volumes/Mobile</code> under mac)</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">sh:</span>
  <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="n">SoS_Docker_Guide</span><span class="o">.</span><span class="n">ipynb</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">Mobile</span>
</pre></div>

</div>
</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The script would fail to execute in a docker image because the image cannot see the <code>/Volumes</code> file system</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="o">%</span><span class="n">sandbox</span> <span class="o">--</span><span class="n">expect</span><span class="o">-</span><span class="n">error</span>
<span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;ubuntu:14.04&#39;</span>
  <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="n">SoS_Docker_Guide</span><span class="o">.</span><span class="n">ipynb</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">Mobile</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>/var/lib/sos/docker_run_37713.sh: 1: /var/lib/sos/docker_run_37713.sh: cannot create /Volumes/Mobile: Directory nonexistent
</pre>
</div>
</div>

<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stderr output_text">
<pre>Executing script in docker returns an error (exitcode=2).
The script has been saved to /var/folders/ys/gnzk0qbx5wbdgm531v82xxljv5yqy8/T/tmpkdejiko3/.sos/docker_run_37713.sh. To reproduce the error please run:
``docker run --rm   -v /private/var/folders/ys/gnzk0qbx5wbdgm531v82xxljv5yqy8/T/tmpkdejiko3:/private/var/folders/ys/gnzk0qbx5wbdgm531v82xxljv5yqy8/T/tmpkdejiko3 -v /var/folders/ys/gnzk0qbx5wbdgm531v82xxljv5yqy8/T/tmpkdejiko3/.sos/docker_run_37713.sh:/var/lib/sos/docker_run_37713.sh    -t -P -w=/private/var/folders/ys/gnzk0qbx5wbdgm531v82xxljv5yqy8/T/tmpkdejiko3 -u 1985961928:895809667    ubuntu:14.04 /bin/sh /var/lib/sos/docker_run_37713.sh``
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The problem could be solved by specifying additional shared file systems through parameter <code>volumes</code>. This parameter accepts one (a string) or a list of volumes (list of strings) in the format of</p>
<ul>
<li>A single path (e.g. <code>/Users</code>) which would be shared to the docker image under the same name (e.g.  <code>/Users:/Users</code>).</li>
<li>A full volume specification <code>host-src:]container-dest[:&lt;options&gt;]</code>, in which case host and container directories can have different names (e.g. <code>/Users:/home</code>).</li>
</ul>
<p>A special rule here is that the current working directory will not be mapped separately if it is under one of the specified volumes. That is to say, if the current working directly is <code>/Users/bpeng1/project</code> and option <code>volumes='/Users:/home'</code> is specified, current working directory will be implicitly mapped to <code>/home/bpeng1/project</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Consequently, if you would like to read input files from or write output files to another file system, you can add the paths to option <code>volumes</code></p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;ubuntu:14.04&#39;</span><span class="p">,</span> <span class="n">volumes</span><span class="o">=</span><span class="s1">&#39;/Volumes&#39;</span>
  <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="n">SoS_Docker_Guide</span><span class="o">.</span><span class="n">ipynb</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">Mobile</span>

<span class="kn">sh:</span>
  <span class="n">cat</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">Mobile</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>731 SoS_Docker_Guide.ipynb
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As another common technique, some users prefer using "standard directories" as input and output directories of a script so that the scripts are more portable. For example, the following script maps source directory as <code>/input</code> and destination directory as <code>/output</code> and use <code>/input</code> and <code>/output</code> in the docker image:</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;ubuntu:14.04&#39;</span><span class="p">,</span>
  <span class="n">volumes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;~/sos/sos-docs/src/tutorials:/input&#39;</span><span class="p">,</span> <span class="s1">&#39;/Volumes:/output&#39;</span><span class="p">]</span>
  <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="nb">input</span><span class="o">/</span><span class="n">SoS_Docker_Guide</span><span class="o">.</span><span class="n">ipynb</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">Mobile</span>

<span class="kn">sh:</span>
  <span class="n">cat</span> <span class="o">/</span><span class="n">Volumes</span><span class="o">/</span><span class="n">Mobile</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>731 /input/SoS_Docker_Guide.ipynb
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Finally, as a word of caution, although it is tempting to share common directories (e.g. <code>/home</code> or <code>/Users</code>) to the docker image, sharing of extra directories can cause unexpected problems. For example, a docker image might contain a useful <code>/Users</code> and sharing host <code>/Users</code> will override the directory inside docker.</p>
<p>Moreover, sharing <code>$HOME</code> will expose a lot of user settings (e.g. <code>.R</code>, <code>.sos</code>) to the docker image and might affect how the docker image runs. If you really need to expose a home directory to a docker image, you might want to expose it as a different directory inside of docker. For example, the following script shared home directory as <code>/data</code> inside docker so that it does not interfere with the home directory of the docker image.</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">sh:</span> <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;ubuntu:14.04&#39;</span><span class="p">,</span> <span class="n">volumes</span><span class="o">=</span><span class="s1">&#39;~:/data&#39;</span>
  <span class="n">ls</span> <span class="o">~</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
  <span class="n">ls</span> <span class="o">/</span><span class="n">data</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>21
46
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Customize-user-and-group-ID-(user)">Customize user and group ID (<code>user</code>)<a class="anchor-link" href="#Customize-user-and-group-ID-(user)">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By default SoS passes option <code>--user $(uid):$(gid)</code> to command <code>docker run</code> to execute the command as the same user as the user on host machine. This makes sure that the docker image has read/write permission to shared volumes and the files written by the docker image are readable by the host machine.</p>
<p>FIXME: example of using image user (<code>user=None</code>)
FIXME: example of using another user (<code>user=blah</code>)</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">docker_build:</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;test_docker_workdir&#39;</span>
  <span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">14.04</span>
  <span class="n">USER</span> <span class="n">blah</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[13]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>0</pre>
</div>

</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Docker-images-with-entry_point">Docker images with <code>entry_point</code><a class="anchor-link" href="#Docker-images-with-entry_point">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Some docker image has an entry point which determines the command that will be executed when the image is executed. If we run the script directly, our "command" (e.g. <code>ruby /var/lib/sos/docker_run_30258.rb</code> will be appended to the entry point and will not be executed properly. Examples of such images include <a href="https://hub.docker.com/r/dceoy/gatk/~/dockerfile/"><code>dceoy/gatk</code></a>, which has an entry point</p>

<pre><code>["java", "-jar", "/usr/local/src/gatk/build/libs/gatk.jar"]</code></pre>
<p>and does not accept any additional interpreter. What we really need to do is to append "arguments" to this pre-specified command.</p>
<p>For example, the <code>test_docker_ls</code> image has an <code>ENTRYPOINT ["ls"]</code></p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">docker_build:</span> <span class="n">tag</span><span class="o">=</span><span class="s1">&#39;test_docker_ls&#39;</span>
  <span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="mf">14.04</span>
  <span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;ls&quot;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[14]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>0</pre>
</div>

</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>which is expected to be used directly with optional parameter and without an interpreter.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Recall that action <code>script</code> does not have a default interpreter, and option <code>args</code> can be used to construct a command line, we can use this docker image in the format of</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">script:</span> <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-l SoS_Docker_Guide.ipynb&#39;</span><span class="p">,</span> <span class="n">docker_image</span> <span class="o">=</span> <span class="s1">&#39;test_docker_ls&#39;</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>-rw-r--r-- 1 1985961928 895809667 24378 May 30 03:22 SoS_Docker_Guide.ipynb
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>which essentially passes <code>-l SoS_Docker_Guide.ipynb</code> to the image and executes command</p>

<pre><code>ls -l SoS_Docker_Guide.ipynb</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If the command line is long, you can use another trick, that is to say, to use <code>{script}</code> in <code>args</code> for scripts of the action. For example, the aforementioned command can be specified as</p>

</div>
</div>
</div><div class="cell border-box-sizing code_cell rendered lan_SoS">
	
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="kn">script:</span> <span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;{script}&#39;</span><span class="p">,</span> <span class="n">docker_image</span> <span class="o">=</span> <span class="s1">&#39;test_docker_ls&#39;</span>
  <span class="o">-</span><span class="n">l</span> <span class="n">SoS_Docker_Guide</span><span class="o">.</span><span class="n">ipynb</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>-rw-r--r-- 1 1985961928 895809667 24378 May 30 03:22 SoS_Docker_Guide.ipynb
</pre>
</div>
</div>

</div>
</div>

</div>
  </div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Limitations">Limitations<a class="anchor-link" href="#Limitations">&#182;</a></h2><ul>
<li>Virtual Box virtual machine does not support symbolic link so running <code>ln -s</code> inside a docker machine under Mac will cause a strange error message <code>Read-only file system</code>.</li>
<li>Killing a sos task or sos process will not terminate scripts that are executed by the docker daemon.</li>
</ul>

</div>
</div>
</div>
    </div>
  </div>
</body>

 


</html>
